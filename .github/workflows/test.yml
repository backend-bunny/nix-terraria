name: Test Build

on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'LICENSE'

jobs:
  test-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Cachix
        uses: cachix/cachix-action@v12
        with:
          name: nix-community
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Test build Docker image
        run: |
          # Allow unfree packages for tModLoader
          export NIXPKGS_ALLOW_UNFREE=1

          # Test build the Docker image (don't load into Docker to save time)
          nix build .#docker --impure

          echo "âœ… Docker image builds successfully!"

      - name: Test NixOS configuration
        run: |
          # Test build the NixOS configuration
          export NIXPKGS_ALLOW_UNFREE=1
          nix build .#nixosConfigurations.terraria-server.config.system.build.toplevel --impure

          echo "âœ… NixOS configuration builds successfully!"

      - name: Generate test summary
        run: |
          echo "## âœ… Build Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All components built successfully:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ³ Docker image" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ NixOS configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ready for merge! ðŸš€" >> $GITHUB_STEP_SUMMARY